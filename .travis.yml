# Watch me run at http://travis-cs.org/ghcjs/ghcjs

env:
    - GHCVER=7.10.1 CABALVER=1.22 HAPPYVER=1.19.4 ALEXVER=3.1.3 TEST_PART=CORE1
    - GHCVER=7.10.1 CABALVER=1.22 HAPPYVER=1.19.4 ALEXVER=3.1.3 TEST_PART=CORE2
    - GHCVER=7.10.1 CABALVER=1.22 HAPPYVER=1.19.4 ALEXVER=3.1.3 TEST_PART=PROFILING
    - GHCVER=7.10.1 CABALVER=1.22 HAPPYVER=1.19.4 ALEXVER=3.1.3 TEST_PART=GHCJS
    - GHCVER=7.8.4 CABALVER=1.22 HAPPYVER=1.19.4 ALEXVER=3.1.3 TEST_PART=CORE1

before_install:
    - export GHCJS_BOOTING=1
    - export GHCJS_BOOTING_STAGE1=1
    - travis_retry sudo add-apt-repository -y ppa:hvr/ghc
    - curl -sL https://deb.nodesource.com/setup | sudo bash -
    - travis_retry sudo apt-get update -qq
    - travis_retry sudo apt-get install nodejs cabal-install-$CABALVER ghc-$GHCVER happy-$HAPPYVER alex-$ALEXVER
    - export PATH=$HOME/.cabal/bin:/opt/ghc/$GHCVER/bin:/opt/cabal/$CABALVER/bin:/opt/happy/$HAPPYVER/bin:/opt/alex/$ALEXVER/bin:$PATH

install:
    - travis_retry cabal update
    - mkdir _ghcjs_deps
    - cd _ghcjs_deps
    - travis_retry git clone https://github.com/seereason/haskell-src-meta
    - travis_retry git clone https://github.com/seereason/th-expand-syns
    - travis_retry git clone https://github.com/hvr/ansi-wl-pprint --branch pr-base48
    - travis_retry git clone https://github.com/seereason/wl-pprint-text
    - travis_retry git clone https://github.com/seereason/stringsearch
    - cabal install -j2 ./haskell-src-meta ./th-expand-syns ./ansi-wl-pprint ./wl-pprint-text ./stringsearch
    - travis_retry git clone https://github.com/ghcjs/ghcjs-prim.git
    - travis_retry git clone https://github.com/haskell/haddock.git
    - cd ghcjs-prim
    - git checkout $TRAVIS_BRANCH
    - cd ..
    - cabal install ./ghcjs-prim
    - |
      dpkg --compare-versions "$GHCVER" lt "7.9" || cabal install -j2 ./haddock/haddock-api ./haddock/haddock-library
    - cd ..
    - cabal install --enable-tests --enable-benchmarks --avoid-reinstalls
    - ghcjs --version
    - ghcjs-boot --version
    - ./test/runTravis.sh boot
    - ghcjs-pkg list

script:
    - ./test/runTravis.sh test

notifications:
  irc:
    channels: "irc.freenode.net#ghcjs"
    skip_join: true
  email: true
